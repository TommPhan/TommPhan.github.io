"use strict";function string_to_justified_array(e,t,n=9){let r=e.split(""),a=r.length,o=Math.ceil(a/n),d=t.split(" ");if(1===n)return[r,d,1,o];let i=[],l=0,c={new_array:[],width:0,height:0};for(;o>0;o--){let e=n*o;for(let t=0;t<a;t++)n<e&&!(l%o)&&/\s/g.test(r[t])||(/\s/g.test(r[t])?i.push(GAP):i.push(r[t]),l++);if(!(n<e&&l<=e-o)){i[l-1]!==r[a-1]&&(i=c.new_array,o=c.height,n=c.width,l=i.length,e=n*o),i[e-1]=i[e-1]?i[e-1]:GAP,i.fill(GAP,l,e-1);break}c=c.height?c:{new_array:i,width:n-Math.floor((e-l)/o),height:o},i=[]}l=i.length;let s=[];for(let e=0,t=0;e<l;e++){let n="";/\s/.test(i[e])||(n=d[t],t++),s.push(n)}return[i,s,n,o]}function array_to_tbrl_table([e,t,n,r],a=0){let o=document.createElement("table"),d=n*r-r,i=[];for(let l=0;l<r;l++){let c=document.createElement("tr");for(let o=0;o<n;o++){let n=document.createElement("td"),s=document.createElement("div"),u=d+l-r*o;/\s/.test(e[u])?(s.appendChild(document.createTextNode(GAP)),s.setAttribute("style","cursor: default")):(s.addEventListener("click",()=>{context?play_character(e[u],t[u]):console.log("To enable audio in Firefox, type 'about:config' in your browser and set 'dom.webaudio.enabled' to 'true' and reload.")}),s.appendChild(document.createTextNode(e[u])),a&&(s.setAttribute("id",`${a}-${u}`),i.push(u))),n.appendChild(s),c.appendChild(n)}o.appendChild(c)}return CHAPTERS[a]=i.sort((e,t)=>e-t),o}function title(e){let t=["道德經","盜德經","道得經","盜得經"];return TBRLTable(t[e],"dao4 de2 jing1",3)}function array_to_anchors(e){let t=e.length,n=new DocumentFragment;for(let r=0;r<t;r++){let a=document.createElement("div"),o=document.createElement("a"),d=document.createTextNode(e[r][1]);0===r||"Guodian"===order&&r>3||("word count"===order||"character count"===order?a.setAttribute("style",`background-color: ${random_colours[0]}`):a.setAttribute("style",`background-color: ${random_colours[r-1]}`)),r===t-1&&a.setAttribute("style","background-color: ''"),a.setAttribute("class","button"),a.appendChild(d),o.setAttribute("href",e[r][0]),o.appendChild(a),n.appendChild(o)}return n}function make_chapter_table([e,t,n]){let r=document.createElement("table");for(var a=0,o=0;a<n;a++){let n=document.createElement("tr");for(let r=0;r<t&&e[o];r++){let t=document.createElement("td");e[o]<MAX+1?t.appendChild(document.createTextNode(e[o])):t.appendChild(document.createTextNode("?")),t.addEventListener("click",e=>to_chapter(e)),t.setAttribute("class","button"),t.setAttribute("style",`background-color: ${chapter_colours[o]}`),n.appendChild(t),o++}r.appendChild(n)}return r}function make_laozi(){let e=material.length,t=MAX/DIVISION,n=0,r=new Array(DIVISION).fill().map(e=>document.createElement("div"));r[0].setAttribute("class","contained"),section_anchors=[];for(let a=1;a<=e;a++){let o=document.createElement("div"),d=document.createElement("h2"),i=document.createElement("div"),l=document.createElement("h3"),c=document.createElement("div"),s=document.createElement("div"),u=material.findIndex(e=>e[order]===a),p=a>1?material.findIndex(e=>e[order]===a-1):0,h=material[u][order];if(o.setAttribute("id",u+1),s.setAttribute("class","chapter"),material[u][`${order}_sections`]&&(material[u][`${order}_sections`]!==material[p][`${order}_sections`]||!u)){let e=material[u][`${order}_sections`].replace(/ *\(*(\d)\)* */g,"");section_anchors.push([`#${u+1}`,material[u][`${order}_sections`].substring(3)]),i.appendChild(document.createTextNode(e)),d.appendChild(i),d.appendChild(document.createTextNode("\n")),o.appendChild(d)}if(!material[u][`${order}_sections`]&&(1===h||h===e)){let e="word count"===order?"Fewest words":"Fewest characters",t="word count"===order?"Most words":"Most characters",n=1===h?e:t;section_anchors.push([`#${u+1}`,n])}l.addEventListener("click",()=>{context?play_chapter(u):console.log("To enable audio in Firefox, type 'about:config' in your browser and set 'dom.webaudio.enabled' to 'true' and reload.")}),c.appendChild(document.createTextNode(material[u]["Fu Yi"])),l.appendChild(c),l.appendChild(document.createTextNode("\n"));let m=document.createElement("div");SHOW.original&&(m.setAttribute("class","original"),m.setAttribute("aria-hidden","true"),m.appendChild(TBRLTable(material[u].original,material[u].pinyin,width,material[u]["Fu Yi"])),m.appendChild(document.createTextNode("\n")));let _=document.createElement("div");if(SHOW.translation){_.setAttribute("class","translation");let e=material[u].translation,t=new DocumentFragment,n=e.replace(/@(.*)/,"").replace(/#/g,"\n\n").split(/(\*+)/),r=n.length;n[r-1]=n[r-1]+"\n";for(let e=0;e<r;e++){if(!SHOW.annotation&&/(\*+)/.test(n[e]))continue;let r="";/(\*+)/.test(n[e])?(r=document.createElement("sup"),r.appendChild(document.createTextNode(n[e].replace(/\*/g,EXTRA))),r.setAttribute("style",`color: ${chapter_colours[u]}`)):r=document.createTextNode(n[e]),t.appendChild(r)}if(_.appendChild(t),SHOW.annotation&&e.includes("@")){let e=document.createElement("small"),t=material[u].translation.replace(/(.*)@/,"\n").replace(/#/g,"\n").split(/(\*+|\(\d+\))/),n=t.length;for(let r=1;r<n;r++){let n="";if(/(\*+)/.test(t[r]))n=document.createElement("sup"),n.appendChild(document.createTextNode(t[r].replace(/\*/g,EXTRA))),n.setAttribute("style",`color: ${chapter_colours[u]}`);else if(/(\(\d+\))/.test(t[r])){let e=t[r].replace(/\D/g,"");n=document.createElement("a"),n.setAttribute("class","button"),n.setAttribute("href",`#${e}`),n.setAttribute("style",`font-style: normal; background-color: ${chapter_colours[e-1]}`),n.appendChild(document.createTextNode(`${GAP}${e}${GAP}`))}else n=document.createTextNode(t[r]);e.appendChild(n)}_.appendChild(document.createTextNode("\n")),_.appendChild(e)}_.appendChild(document.createTextNode("\n"))}if(i.setAttribute("style",`color: white;\n      background-color: ${chapter_colours[u]};\n      width: fit-content;\n      width: -moz-fit-content;\n      min-width: 2.2rem;\n      margin: 0 auto;\n      padding: 0.3rem 0.8rem;\n      border-radius: 24px;`),c.setAttribute("style",`color: white;\n      background-color: ${chapter_colours[u]};\n      width: 2.2rem;\n      margin: 0 auto;\n      padding: 0 0.6rem;\n      line-height: 2rem;\n      border-radius: 24px;`),s.appendChild(l),SHOW.original&&s.appendChild(m),SHOW.translation&&s.appendChild(_),SHOW.annotation&&("Guodian"===order&&h<32||"Mawangdui"===order)){let e=document.createElement("small"),t=`${order}: ${"Guodian"===order&&h>13?h+1:h}\n\n`;e.appendChild(document.createTextNode(t)),s.appendChild(e)}o.appendChild(s),r[n].appendChild(o),!(a%t)&&a<e&&(n++,r[n].setAttribute("class","contained"))}let a=document.createElement("h2");a.appendChild(document.createTextNode("Chapters\n\n"));let o=document.createElement("div"),d=make_chapter_table([make_chapter_array(),width,Math.ceil((MAX+1)/width)]);o.setAttribute("class","chapter_table"),o.setAttribute("style","padding: 1rem 1rem 0"),o.appendChild(d),o.appendChild(document.createTextNode("\n")),section_anchors.unshift(["#chapters","Chapters"]),section_anchors.push(["#extra","Extra"]);let i=document.createElement("div");return i.setAttribute("id","page_sections"),i.appendChild(document.createTextNode("\n")),i.appendChild(array_to_anchors(section_anchors)),i.appendChild(document.createTextNode("\n")),r[0].prepend(i),r[0].prepend(make_sorter()),r[0].prepend(o),r[0].prepend(a),r}function make_menu(){let e=document.createElement("div");e.appendChild(array_to_anchors([["#","Top"]])),e.setAttribute("id","top");let t=document.createElement("div"),n=make_chapter_table([make_chapter_array(),width,Math.ceil((MAX+1)/width)]);t.setAttribute("class","chapter_table"),t.appendChild(n);let r=document.createElement("div"),a=document.createElement("div");a.appendChild(array_to_anchors(section_anchors)),r.setAttribute("id","section_menu"),r.appendChild(a);let o=document.createElement("div");return o.setAttribute("id","menu_inner"),o.setAttribute("class","round contained"),o.appendChild(e),o.appendChild(t),o.appendChild(r),o.appendChild(make_sorter()),o}function make_sorter(){let e=document.createElement("form"),t=document.createElement("select"),n=new DocumentFragment;return orders.forEach(e=>{let t=document.createElement("option");t.appendChild(document.createTextNode(e)),e===ORDER&&t.setAttribute("selected","selected"),n.appendChild(t)}),t.appendChild(n),e.appendChild(document.createTextNode(`Sorting by${GAP}`)),e.appendChild(t),e.addEventListener("change",change_order),e}function colourise_chapters(){const e=["#2e5a85","#375f52","#0052b9","#7b2bc3","#5f5566","#8c3c72","#7c4a4b","#4e3cda","#465875","#2a6233","#005f7c","#4f547c","#9a353a"];let t="";if(random_colours=random_order().map(t=>e[t]),t=random_colours[0],"word count"===order||"character count"===order)return void(chapter_colours=new Array(MAX).fill().map(()=>t));let n=[...new Set(material.map(e=>e[`${order}_sections`]))].sort();for(let e=0;e<MAX;e++){let r=material[e][`${order}_sections`];t="Guodian"!==order||"04 Absent upper (21)"!==r&&"05 Absent lower (29)"!==r?random_colours[n.indexOf(r)]:"dimgrey",chapter_colours[e]=t}}function load_buffer(e){let t=0;return new Promise(n=>{e in buffers&&n(buffers[e]);let r=new XMLHttpRequest,a=`sound/${e}.mp3`;r.open("GET",a,!0),r.responseType="arraybuffer",r.onload=(()=>{context.decodeAudioData(r.response,t=>{buffers[e]=t,n(t)},()=>{console.log("Buffer not loaded. To retry."),t++,t<10&&load_buffer(e)})}),r.send()})}function karaoke(e,t){let n=document.getElementById(`${e}-${t}`);n.setAttribute("style","font-weight: bold"),setTimeout(()=>n.setAttribute("style","font-weight: normal"),100)}function play(e,t=0,n,r){"suspended"===context.state&&context.resume();let a=context.createBufferSource();sources[t]=a,load_buffer(e).then(e=>{a.buffer=e,a.connect(context.destination),a.start(t,0,1),a.onended=(()=>{n&&SHOW.original&&karaoke(n,CHAPTERS[n][r]),delete sources[t]})})}function stop_sound(){context.suspend().then(()=>{Object.keys(sources).forEach(e=>sources[e].stop()),context.resume()})}function play_sequence(e,t,n){if(Object.keys(sources).length)return void stop_sound();let r=e.split(" ");Promise.all([r.map(e=>load_buffer(e))]).then(()=>{let e=r.length,a=t.split("").map(Number),o=.2,d=.5,i=context.currentTime+d;for(let t=0;t<e&&r[t];t++){let e=i+t*o,d=a[t]-1;play(r[t],e,n,t),i+=d*o}})}function original_to_rhythm(e){let t=e.split(""),n="";for(let[e]of t.entries()){if(/\s/.test(t[e]))continue;let r=1;/\s/.test(t[e+1])&&(r++,/\s/.test(t[e+2])&&r++),n+=r}return n}function play_character(e,t){console.log(`Word: ${e}\nPinyin: ${t}`),play(t)}function play_chapter(e){let t=material[e],n=t.pinyin,r=original_to_rhythm(t.original),a=t.original.replace(/  /g,"\n"),o=t.translation.replace(/@(.*)/,"").replace(/#/g,"\n\n").replace(/(\*+)/g,""),d=chinese_number(e+1);console.log(`老子 〈傅奕古本 第${d}章〉\n\n${a}\n  \nLaozi (Fu Yi's Ancient Copy, Chapter ${e+1})\n\n${o}`),play_sequence(n,r,e+1)}function chinese_number(e){const t=["一","二","三","四","五","六","七","八","九","十"],n=t[9];e+="";let r=e.length>1?"1"!==e.substr(-2,1)?t[e.substr(-2,1)-1]+n:n:"",a="0"!==e.substr(-1,1)?t[e.substr(-1,1)-1]:"",o=r+a;return o}function replace_child(e,t){let n=document.getElementById(t);n.replaceChild(e,n.firstElementChild)}function replace_children(){width=get_width();for(let e=0;e<DIVISION;e++)e?replace_child(make_laozi()[e],`laozi${e+1}`):replace_child(make_laozi()[0],"chapters");replace_child(make_menu(),"menu")}function change_order(e){ORDER=e.target.value,order=ORDER.replace(/.*: /,""),colourise_chapters(),replace_children()}function glitch(e){phase_step>PHASE_INTERVAL?(replace_child(title(0),"title"),phase_step=0):phase_step>STABLE_BAR&&e-last>UPDATE_INTERVAL&&(replace_child(title(random_number(4)),"title"),last=e),phase_step++,requestAnimationFrame(glitch)}function to_chapter(e){e.preventDefault();let t=e.target.innerText;location.href="?"===t?`#${random_number(MAX)+1}`:`#${t}`}function make_fold(){let e=document.createElement("div"),t=document.createElement("h1"),n=document.createElement("h1"),r=document.createElement("h1"),a=document.createElement("h1"),o=document.createElement("form"),d=document.createElement("div"),i=document.createElement("input"),l=document.createElement("input"),c=document.createElement("input"),s=document.createElement("label"),u=document.createElement("label"),p=document.createElement("label");return t.appendChild(TBRLTable("老子","lao2 zi3",1)),n.appendChild(title(0)),n.setAttribute("id","title"),r.appendChild(TBRLTable("五千言","wu3 qian1 yan2",1)),a.appendChild(document.createTextNode("Laozi Recited")),i.setAttribute("type","checkbox"),l.setAttribute("type","checkbox"),c.setAttribute("type","checkbox"),i.setAttribute("id","annotation"),l.setAttribute("id","translation"),c.setAttribute("id","original"),i.setAttribute("value","annotation"),l.setAttribute("value","translation"),c.setAttribute("value","original"),i.setAttribute("checked","true"),l.setAttribute("checked","true"),c.setAttribute("checked","true"),s.setAttribute("for","annotation"),u.setAttribute("for","translation"),p.setAttribute("for","original"),s.appendChild(document.createTextNode("annotation")),u.appendChild(document.createTextNode("translation")),p.appendChild(document.createTextNode("original")),d.appendChild(document.createTextNode("Showing for each chapter")),o.appendChild(d),o.appendChild(c),o.appendChild(p),o.appendChild(l),o.appendChild(u),o.appendChild(i),o.appendChild(s),o.setAttribute("style","padding: 8rem 1rem;"),o.addEventListener("change",e=>{SHOW[e.target.id]=e.target.checked,replace_children()}),e.appendChild(t),e.appendChild(n),e.appendChild(r),e.appendChild(a),e.appendChild(o),e.setAttribute("class","contained"),e}const TBRLTable=(e,t,n,r)=>array_to_tbrl_table(string_to_justified_array(e,t,n),r),make_chapter_array=(e=1,t=82)=>Array(t-e+1).fill().map((t,n)=>e+n),random_number=e=>Math.floor(Math.random()*e),random_order=()=>{let e=13,t=13,n=[];for(let r=0;r<t;r++){let t=0;do{t=random_number(e)}while(n.includes(t));n.push(t)}return n},get_width=()=>{let e=9,t=8,n=Math.min(t,Math.floor((screen_width-320)/30));return e+n};let screen_width=320,width=9,timeout=0;const DELAY=10,UPDATE_INTERVAL=100,PHASE_INTERVAL=300,STABLE_BAR=200;let last=0,phase_step=0;const MAX=81,GAP=" ",EXTRA="*",SHOW={annotation:!0,translation:!0,original:!0},DIVISION=3,MENU=document.getElementById("menu"),CHAPTERS=new Array(MAX),orders=["theme","word count","character count","<278 BCE: Guodian","<202 BCE: Fu Yi","<168 BCE: Mawangdui"];let context,ORDER=orders[4],order=ORDER.replace(/.*: /,""),section_anchors=[["#chapters","Chapters"],["#1",material[0]["Fu Yi_sections"].substring(3)],["#38",material[37]["Fu Yi_sections"].substring(3)],["#extra","Extra"]],random_colours=[],chapter_colours=[];try{context=new AudioContext({latencyHint:"interactive",sampleRate:8e3})}catch(e){console.log("To enable audio in Firefox, type 'about:config' in your browser and set 'dom.webaudio.enabled' to 'true'")}let buffers={},sources={};window.addEventListener("resize",()=>{let e=window.innerWidth;screen_width!==e&&(screen_width=e,clearTimeout(timeout),timeout=setTimeout(()=>{replace_children()},DELAY))}),window.addEventListener("load",()=>{let e=window.innerWidth;screen_width!==e&&(screen_width=e,replace_children())}),document.getElementById("menu_icon").addEventListener("click",()=>{MENU.style.visibility="hidden"===MENU.style.visibility||""===MENU.style.visibility?"visible":"hidden"}),document.getElementById("fold").addEventListener("click",()=>{MENU.style.visibility="hidden"});for(let e=1;e<DIVISION;e++)document.getElementById(`laozi${e+1}`).addEventListener("click",()=>{MENU.style.visibility="hidden"});document.getElementById("chapters").addEventListener("click",()=>{MENU.style.visibility="hidden"}),document.getElementById("extra").addEventListener("click",()=>{MENU.style.visibility="hidden"}),replace_child(make_fold(),"fold"),colourise_chapters(),replace_children(),glitch();
